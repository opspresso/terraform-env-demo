repos:
  - id: /.*/
    # allow_custom_workflows: true
    # allowed_overrides:
    #   - apply_requirements
    #   - workflow
    # apply_requirements:
    #   - approved
    workflow: terraform-infracost
    post_workflow_hooks:
      - run: |
          if [ ! -d "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM" ]; then
            exit 0
          fi
          infracost comment github --repo $BASE_REPO_OWNER/$BASE_REPO_NAME --pull-request $PULL_NUM \
            --path /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM/infracost-output.json \
            --github-token $GITHUB_TOKEN --behavior new
          rm -rf /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM

workflows:
  terraform-infracost:
    plan:
      steps:
        - init
        - plan
        # - env:
        #     name: INFRACOST_API_KEY
        #     command: echo "$INFRACOST_API_KEY"
        # - env:
        #     name: INFRACOST_TERRAFORM_BINARY
        #     command: echo "terraform${ATLANTIS_TERRAFORM_VERSION}"
        # - run: "/home/atlantis/infracost_atlantis_diff.sh"
        - env:
            name: INFRACOST_OUTPUT
            command: echo "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM/infracost-output.json"
        - show:
            run: |
              if [ ! -d "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM" ]; then
                mkdir -p /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM
              fi
              infracost breakdown --path=$SHOWFILE --format=json --log-level=info --out-file=$INFRACOST_OUTPUT

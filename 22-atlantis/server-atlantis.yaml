repos:
  - id: /.*/
    # allow_custom_workflows: true
    # allowed_overrides:
    #   - apply_requirements
    #   - workflow
    # apply_requirements:
    #   - approved
    workflow: terraform-infracost

workflows:
  terraform-infracost:
    plan:
      steps:
        - env:
            name: INFRACOST_OUTPUT
            command: echo "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM/infracost-output.json"
        - init
        - plan
        - show
        - run: |
            mkdir -p /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM
            infracost breakdown --path=$SHOWFILE --format=json --log-level=info --out-file=$INFRACOST_OUTPUT
        - run: |
            if [ ! -d "/tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM" ]; then; exit 0; fi
            infracost comment github --repo $BASE_REPO_OWNER/$BASE_REPO_NAME --pull-request $PULL_NUM \
              --path /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM/infracost-output.json \
              --github-token $GITHUB_TOKEN --behavior new
            rm -rf /tmp/$BASE_REPO_OWNER-$BASE_REPO_NAME-$PULL_NUM
